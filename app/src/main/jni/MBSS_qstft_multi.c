/*
 * File: MBSS_qstft_multi.c
 *
 * MATLAB Coder version            : 5.2
 * C/C++ source code generated on  : 03-Nov-2021 11:11:15
 */

/* Include Files */
#include "MBSS_qstft_multi.h"
#include "FFTImplementationCallback.h"
#include "main5_emxutil.h"
#include "main5_types.h"
#include "rt_nonfinite.h"
#include <math.h>
#include <string.h>

/* Function Definitions */
/*
 * File MBSS_qstft_multi.m
 *  Quadratic linear-scale time-frequency transform based on the local
 *  covariance of a STFT with sine windows
 *
 *  [Cx,f]=MBSS_qstft_multi(x,fs,wlen,lf,lt)
 *
 *  Inputs:
 *  x: nsampl x nchan vector containing a multichannel signal
 *  fs: sampling frequency in Hz
 *  wlen: length of the STFT window (must be a power of 2)
 *  lf: half-width of the frequency neighborhood for the computation of
 *  empirical covariance
 *  lt: half-width of the time neighborhood for the computation of empirical
 *  covariance
 *
 *  Output:
 *  Cx: nchan x nchan x nbin x nfram matrix containing the spatial covariance
 *  matrices of the input signal in all time-frequency bins
 *  startSample: nfram x 1 , start sample of each frame
 *  endSample: nfram x 1, last sample of each frame
 *
 *
 * Arguments    : creal_T Cx[131584]
 * Return Type  : void
 */
void MBSS_qstft_multi(short b_x[12288],creal_T Cx[131584])
{
  static const double b_dv[512] = {
      0.0030679615757712823, 0.009203884727313847, 0.015339807878856412,
      0.021475731030398976,  0.027611654181941541, 0.0337475773334841,
      0.039883500485026674,  0.046019423636569232, 0.0521553467881118,
      0.058291269939654361,  0.064427193091196933, 0.07056311624273949,
      0.076699039394282062,  0.08283496254582462,  0.088970885697367191,
      0.095106808848909749,  0.10124273200045232,  0.10737865515199488,
      0.11351457830353745,   0.11965050145508001,  0.12578642460662257,
      0.13192234775816514,   0.13805827090970771,  0.14419419406125028,
      0.15033011721279282,   0.1564660403643354,   0.16260196351587797,
      0.16873788666742054,   0.17487380981896308,  0.18100973297050565,
      0.18714565612204823,   0.1932815792735908,   0.19941750242513334,
      0.20555342557667591,   0.21168934872821848,  0.21782527187976106,
      0.2239611950313036,    0.23009711818284617,  0.23623304133438874,
      0.24236896448593132,   0.24850488763747386,  0.25464081078901646,
      0.260776733940559,     0.26691265709210155,  0.27304858024364415,
      0.27918450339518669,   0.28532042654672923,  0.29145634969827183,
      0.29759227284981438,   0.303728196001357,    0.30986411915289952,
      0.31600004230444206,   0.32213596545598466,  0.32827188860752721,
      0.33440781175906975,   0.34054373491061235,  0.34667965806215489,
      0.35281558121369749,   0.35895150436524004,  0.36508742751678258,
      0.37122335066832518,   0.37735927381986772,  0.38349519697141027,
      0.38963112012295287,   0.39576704327449541,  0.401902966426038,
      0.40803888957758055,   0.4141748127291231,   0.4203107358806657,
      0.42644665903220824,   0.43258258218375079,  0.43871850533529339,
      0.44485442848683593,   0.45099035163837853,  0.45712627478992107,
      0.46326219794146362,   0.46939812109300622,  0.47553404424454876,
      0.4816699673960913,    0.4878058905476339,   0.49394181369917645,
      0.500077736850719,     0.50621366000226153,  0.51234958315380419,
      0.51848550630534673,   0.52462142945688928,  0.53075735260843182,
      0.53689327575997436,   0.543029198911517,    0.54916512206305956,
      0.55530104521460211,   0.56143696836614465,  0.56757289151768719,
      0.57370881466922985,   0.57984473782077239,  0.58598066097231494,
      0.59211658412385748,   0.5982525072754,      0.60438843042694257,
      0.61052435357848522,   0.61666027673002777,  0.62279619988157031,
      0.62893212303311286,   0.6350680461846554,   0.641203969336198,
      0.6473398924877406,    0.65347581563928314,  0.65961173879082569,
      0.66574766194236823,   0.67188358509391088,  0.67801950824545343,
      0.684155431396996,     0.69029135454853852,  0.69642727770008106,
      0.7025632008516236,    0.70869912400316626,  0.7148350471547088,
      0.72097097030625135,   0.72710689345779389,  0.73324281660933643,
      0.73937873976087909,   0.74551466291242163,  0.75165058606396418,
      0.75778650921550672,   0.76392243236704926,  0.77005835551859192,
      0.77619427867013446,   0.782330201821677,    0.78846612497321955,
      0.79460204812476209,   0.80073797127630464,  0.80687389442784729,
      0.81300981757938984,   0.81914574073093238,  0.82528166388247493,
      0.83141758703401747,   0.83755351018556012,  0.84368943333710267,
      0.84982535648864521,   0.85596127964018776,  0.8620972027917303,
      0.868233125943273,     0.8743690490948155,   0.880504972246358,
      0.88664089539790059,   0.89277681854944313,  0.89891274170098567,
      0.90504866485252833,   0.91118458800407087,  0.91732051115561342,
      0.923456434307156,     0.9295923574586985,   0.93572828061024116,
      0.9418642037617837,    0.94800012691332625,  0.95413605006486879,
      0.96027197321641133,   0.966407896367954,    0.97254381951949653,
      0.97867974267103908,   0.98481566582258162,  0.99095158897412416,
      0.99708751212566671,   1.0032234352772094,   1.0093593584287519,
      1.0154952815802945,    1.021631204731837,    1.0277671278833795,
      1.0339030510349221,    1.0400389741864646,   1.0461748973380072,
      1.05231082048955,      1.0584467436410925,   1.064582666792635,
      1.0707185899441776,    1.0768545130957201,   1.0829904362472627,
      1.0891263593988052,    1.0952622825503477,   1.1013982057018903,
      1.1075341288534328,    1.1136700520049756,   1.1198059751565181,
      1.1259418983080607,    1.1320778214596032,   1.1382137446111458,
      1.1443496677626883,    1.1504855909142309,   1.1566215140657734,
      1.1627574372173159,    1.1688933603688585,   1.175029283520401,
      1.1811652066719438,    1.1873011298234863,   1.1934370529750289,
      1.1995729761265714,    1.205708899278114,    1.2118448224296565,
      1.2179807455811991,    1.2241166687327416,   1.2302525918842842,
      1.2363885150358267,    1.2425244381873692,   1.248660361338912,
      1.2547962844904545,    1.2609322076419971,   1.2670681307935396,
      1.2732040539450822,    1.2793399770966247,   1.2854759002481673,
      1.2916118233997098,    1.2977477465512524,   1.3038836697027949,
      1.3100195928543377,    1.3161555160058802,   1.3222914391574228,
      1.3284273623089653,    1.3345632854605078,   1.3406992086120504,
      1.3468351317635929,    1.3529710549151355,   1.359106978066678,
      1.3652429012182206,    1.3713788243697631,   1.3775147475213059,
      1.3836506706728484,    1.389786593824391,    1.3959225169759335,
      1.402058440127476,     1.4081943632790186,   1.4143302864305611,
      1.4204662095821037,    1.4266021327336462,   1.4327380558851888,
      1.4388739790367313,    1.4450099021882741,   1.4511458253398166,
      1.4572817484913592,    1.4634176716429017,   1.4695535947944443,
      1.4756895179459868,    1.4818254410975293,   1.4879613642490719,
      1.4940972874006144,    1.500233210552157,    1.5063691337036997,
      1.5125050568552423,    1.5186409800067848,   1.5247769031583274,
      1.53091282630987,      1.5370487494614125,   1.543184672612955,
      1.5493205957644975,    1.55545651891604,     1.5615924420675826,
      1.5677283652191252,    1.5738642883706679,   1.5800002115222105,
      1.586136134673753,     1.5922720578252956,   1.5984079809768381,
      1.6045439041283807,    1.6106798272799232,   1.6168157504314657,
      1.6229516735830083,    1.6290875967345508,   1.6352235198860934,
      1.6413594430376361,    1.6474953661891787,   1.6536312893407212,
      1.6597672124922638,    1.6659031356438063,   1.6720390587953489,
      1.6781749819468914,    1.684310905098434,    1.6904468282499765,
      1.696582751401519,     1.7027186745530618,   1.7088545977046044,
      1.7149905208561469,    1.7211264440076894,   1.727262367159232,
      1.7333982903107745,    1.7395342134623171,   1.7456701366138596,
      1.7518060597654022,    1.7579419829169447,   1.7640779060684872,
      1.77021382922003,      1.7763497523715726,   1.7824856755231151,
      1.7886215986746576,    1.7947575218262002,   1.8008934449777427,
      1.8070293681292853,    1.8131652912808278,   1.8193012144323704,
      1.8254371375839129,    1.8315730607354554,   1.8377089838869982,
      1.8438449070385408,    1.8499808301900833,   1.8561167533416258,
      1.8622526764931684,    1.8683885996447109,   1.8745245227962535,
      1.880660445947796,     1.8867963690993386,   1.8929322922508811,
      1.8990682154024239,    1.9052041385539664,   1.911340061705509,
      1.9174759848570515,    1.9236119080085941,   1.9297478311601366,
      1.9358837543116791,    1.9420196774632217,   1.9481556006147642,
      1.9542915237663068,    1.9604274469178493,   1.9665633700693921,
      1.9726992932209346,    1.9788352163724772,   1.9849711395240197,
      1.9911070626755623,    1.9972429858271048,   2.0033789089786476,
      2.00951483213019,      2.0156507552817327,   2.021786678433275,
      2.0279226015848177,    2.03405852473636,     2.0401944478879028,
      2.0463303710394452,    2.0524662941909879,   2.0586022173425302,
      2.064738140494073,     2.0708740636456158,   2.0770099867971581,
      2.0831459099487009,    2.0892818331002432,   2.0954177562517859,
      2.1015536794033283,    2.107689602554871,    2.1138255257064134,
      2.1199614488579561,    2.1260973720094984,   2.1322332951610412,
      2.138369218312584,     2.1445051414641263,   2.1506410646156691,
      2.1567769877672114,    2.1629129109187542,   2.1690488340702965,
      2.1751847572218392,    2.1813206803733816,   2.1874566035249243,
      2.1935925266764671,    2.1997284498280094,   2.2058643729795522,
      2.2120002961310945,    2.2181362192826373,   2.2242721424341796,
      2.2304080655857224,    2.2365439887372647,   2.2426799118888074,
      2.2488158350403498,    2.2549517581918925,   2.2610876813434353,
      2.2672236044949776,    2.2733595276465204,   2.2794954507980627,
      2.2856313739496055,    2.2917672971011478,   2.2979032202526906,
      2.3040391434042329,    2.3101750665557756,   2.316310989707318,
      2.3224469128588607,    2.3285828360104035,   2.3347187591619458,
      2.3408546823134886,    2.3469906054650309,   2.3531265286165737,
      2.359262451768116,     2.3653983749196588,   2.3715342980712011,
      2.3776702212227439,    2.3838061443742862,   2.3899420675258289,
      2.3960779906773717,    2.402213913828914,    2.4083498369804568,
      2.4144857601319991,    2.4206216832835419,   2.4267576064350842,
      2.432893529586627,     2.4390294527381693,   2.4451653758897121,
      2.4513012990412544,    2.4574372221927971,   2.46357314534434,
      2.4697090684958822,    2.475844991647425,    2.4819809147989673,
      2.48811683795051,      2.4942527611020524,   2.5003886842535952,
      2.5065246074051375,    2.5126605305566803,   2.5187964537082226,
      2.5249323768597653,    2.5310683000113081,   2.5372042231628504,
      2.5433401463143932,    2.5494760694659355,   2.5556119926174783,
      2.5617479157690206,    2.5678838389205634,   2.5740197620721057,
      2.5801556852236485,    2.5862916083751912,   2.5924275315267336,
      2.5985634546782763,    2.6046993778298186,   2.6108353009813614,
      2.6169712241329037,    2.6231071472844465,   2.6292430704359888,
      2.6353789935875316,    2.6415149167390739,   2.6476508398906167,
      2.6537867630421594,    2.6599226861937018,   2.6660586093452445,
      2.6721945324967868,    2.6783304556483296,   2.6844663787998719,
      2.6906023019514147,    2.696738225102957,    2.7028741482545,
      2.7090100714060421,    2.7151459945575849,   2.7212819177091276,
      2.72741784086067,      2.7335537640122127,   2.739689687163755,
      2.7458256103152978,    2.75196153346684,     2.7580974566183829,
      2.7642333797699252,    2.770369302921468,    2.7765052260730103,
      2.7826411492245531,    2.7887770723760958,   2.7949129955276382,
      2.8010489186791809,    2.8071848418307233,   2.813320764982266,
      2.8194566881338083,    2.8255926112853511,   2.8317285344368934,
      2.8378644575884362,    2.8440003807399785,   2.8501363038915213,
      2.856272227043064,     2.8624081501946064,   2.8685440733461491,
      2.8746799964976915,    2.8808159196492342,   2.8869518428007765,
      2.8930877659523193,    2.8992236891038616,   2.9053596122554044,
      2.9114955354069467,    2.9176314585584895,   2.9237673817100323,
      2.9299033048615746,    2.9360392280131173,   2.9421751511646597,
      2.9483110743162024,    2.9544469974677448,   2.9605829206192875,
      2.96671884377083,      2.9728547669223726,   2.9789906900739154,
      2.9851266132254577,    2.9912625363770005,   2.9973984595285428,
      3.0035343826800855,    3.0096703058316279,   3.0158062289831706,
      3.021942152134713,     3.0280780752862557,   3.034213998437798,
      3.0403499215893408,    3.0464858447408836,   3.0526217678924259,
      3.0587576910439687,    3.064893614195511,    3.0710295373470538,
      3.0771654604985961,    3.0833013836501388,   3.0894373068016812,
      3.0955732299532239,    3.1017091531047662,   3.107845076256309,
      3.1139809994078518,    3.1201169225593941,   3.1262528457109369,
      3.1323887688624792,    3.138524692014022};
  static const double winf[15] = {0.038060233744356631, 0.14644660940672621,
                                  0.30865828381745508,  0.49999999999999994,
                                  0.69134171618254481,  0.85355339059327373,
                                  0.96193976625564337,  1.0,
                                  0.96193976625564337,  0.85355339059327373,
                                  0.69134171618254481,  0.49999999999999994,
                                  0.30865828381745508,  0.14644660940672621,
                                  0.038060233744356631};
  static const double dv1[3] = {0.49999999999999994, 1.0, 0.49999999999999994};

  emxArray_creal_T *XX;
  emxArray_creal_T *a;
  emxArray_creal_T *r;
  emxArray_real_T *wei;
  creal_T X[8224];
  creal_T fframe[512];
  creal_T local_Cx[256];
  double b_tmp_data[514];
  double frame[512];
  double x[512];
  double tmp_data[257];
  double pairId[240];
  double b_data[2];
  double XX_im;
  double XX_re;
  double s_im;
  double s_re;
  int comb[2];
  int Cx_tmp;
  int b_i;
  int coffset;
  int combj;
  int f;
  int i;
  int icomb;
  int indf_size_idx_1;
  int j;
  int k;
  int nind;
  int nmkpi;
  int t;
  short indf_data[257];
  /* %% Errors and warnings %%% */
  /* %% STFT %%% */
  /*  File MBSS_stft_multi.m */
  /*  Multichannel short-time Fourier transform (STFT) using */
  /*  half-overlapping sine windows. */
  /*  */
  /*  X=MBSS_stft_multi(x,wlen) */
  /*  */
  /*  Inputs: */
  /*  x: nchan x nsampl matrix containing nchan time-domain mixture signals */
  /*  with nsampl samples */
  /*  wlen: window length (default: 1024 samples or 64ms at 16 kHz, which is */
  /*  optimal for speech source separation via binary time-frequency masking) */
  /*  */
  /*  Output: */
  /*  X: nbin x nfram x nchan matrix containing the STFT coefficients with nbin
   */
  /*  frequency bins and nfram time frames */
  /*  startSample: nfram x 1 , start sample of each frame */
  /*  endSample: nfram x 1, last sample of each frame */
  /* %% Errors and warnings %%% */
  /* %% Computing STFT coefficients %%% */
  /*  Defining sine window */
  for (k = 0; k < 512; k++) {
    x[k] = sin(b_dv[k]);
  }
  /*  Start and end sample id of each frames */
  for (i = 0; i < 16; i++) {
    for (t = 0; t < 2; t++) {
      /*  Framing */
      s_re = (double)t * 512.0 / 2.0;
      for (b_i = 0; b_i < 512; b_i++) {
        frame[b_i] =
            (double)b_x[i + (((int)(s_re + ((double)b_i + 1.0)) - 1) << 4)] *
            x[b_i];
      }
      /*  FFT */
      c_FFTImplementationCallback_doH(frame, fframe);
      memcpy(&X[i * 514 + t * 257], &fframe[0], 257U * sizeof(creal_T));
    }
  }
  /* %% Computation of local covariances for each pair of microphone %%% */
  /*  winf=hanning(2*8-1); */
  /*  wint=hanning(2*2-1).'; */
  /*  Cx = zeros(nchan,nchan,nbin,nfram); */
  memset(&Cx[0], 0, 131584U * sizeof(creal_T));
  comb[0] = 1;
  comb[1] = 2;
  icomb = 1;
  nmkpi = 16;
  for (k = 0; k < 120; k++) {
    pairId[k] = (double)(comb[0] - 1) + 1.0;
    pairId[k + 120] = (double)(comb[1] - 1) + 1.0;
    if (icomb + 1 > 0) {
      coffset = comb[icomb];
      combj = comb[icomb] + 1;
      comb[icomb]++;
      if (coffset + 1 < nmkpi) {
        b_i = icomb + 2;
        for (j = b_i; j < 3; j++) {
          combj++;
          comb[1] = combj;
        }
        icomb = 1;
        nmkpi = 16;
      } else {
        icomb--;
        nmkpi--;
      }
    }
  }
  emxInit_real_T(&wei, 2);
  emxInit_creal_T(&XX, 2);
  emxInit_creal_T(&r, 3);
  emxInit_creal_T(&a, 2);
  for (f = 0; f < 257; f++) {
    coffset = (int)fmax(1.0, (((double)f + 1.0) - 8.0) + 1.0);
    icomb = (int)fmin(257.0, (((double)f + 1.0) + 8.0) - 1.0);
    if (icomb < coffset) {
      indf_size_idx_1 = 0;
    } else {
      icomb -= coffset;
      indf_size_idx_1 = icomb + 1;
      for (b_i = 0; b_i <= icomb; b_i++) {
        indf_data[b_i] = (short)(coffset + b_i);
      }
    }
    nind = indf_size_idx_1 << 1;
    Cx_tmp = f << 8;
    for (b_i = 0; b_i < indf_size_idx_1; b_i++) {
      tmp_data[b_i] = winf[(indf_data[b_i] - f) + 6];
    }
    for (t = 0; t < 2; t++) {
      b_data[0] = dv1[1 - t];
      b_data[1] = dv1[2 - t];
      for (b_i = 0; b_i < 2; b_i++) {
        for (icomb = 0; icomb < indf_size_idx_1; icomb++) {
          b_tmp_data[icomb + indf_size_idx_1 * b_i] =
              tmp_data[icomb] * b_data[b_i];
        }
      }
      b_i = wei->size[0] * wei->size[1];
      wei->size[0] = 16;
      wei->size[1] = nind;
      emxEnsureCapacity_real_T(wei, b_i);
      for (b_i = 0; b_i < nind; b_i++) {
        for (icomb = 0; icomb < 16; icomb++) {
          wei->data[icomb + 16 * b_i] = b_tmp_data[b_i];
        }
      }
      b_i = r->size[0] * r->size[1] * r->size[2];
      r->size[0] = indf_size_idx_1;
      r->size[1] = 2;
      r->size[2] = 16;
      emxEnsureCapacity_creal_T(r, b_i);
      for (b_i = 0; b_i < 16; b_i++) {
        for (icomb = 0; icomb < 2; icomb++) {
          for (nmkpi = 0; nmkpi < indf_size_idx_1; nmkpi++) {
            r->data[(nmkpi + r->size[0] * icomb) +
                    r->size[0] * r->size[1] * b_i] =
                X[((indf_data[nmkpi] + 257 * icomb) + 514 * b_i) - 1];
          }
        }
      }
      b_i = XX->size[0] * XX->size[1];
      XX->size[0] = 16;
      XX->size[1] = nind;
      emxEnsureCapacity_creal_T(XX, b_i);
      for (b_i = 0; b_i < nind; b_i++) {
        for (icomb = 0; icomb < 16; icomb++) {
          XX->data[icomb + 16 * b_i] = r->data[b_i + nind * icomb];
        }
      }
      b_i = a->size[0] * a->size[1];
      a->size[0] = 16;
      a->size[1] = XX->size[1];
      emxEnsureCapacity_creal_T(a, b_i);
      icomb = 16 * XX->size[1];
      for (b_i = 0; b_i < icomb; b_i++) {
        a->data[b_i].re = wei->data[b_i] * XX->data[b_i].re;
        a->data[b_i].im = wei->data[b_i] * XX->data[b_i].im;
      }
      combj = a->size[1];
      for (j = 0; j < 16; j++) {
        coffset = j << 4;
        for (i = 0; i < 16; i++) {
          s_re = 0.0;
          s_im = 0.0;
          for (k = 0; k < combj; k++) {
            icomb = k << 4;
            nmkpi = icomb + j;
            XX_re = XX->data[nmkpi].re;
            XX_im = -XX->data[nmkpi].im;
            icomb += i;
            s_re += a->data[icomb].re * XX_re - a->data[icomb].im * XX_im;
            s_im += a->data[icomb].re * XX_im + a->data[icomb].im * XX_re;
          }
          b_i = coffset + i;
          local_Cx[b_i].re = s_re;
          local_Cx[b_i].im = s_im;
        }
      }
      icomb = wei->size[1];
      if (wei->size[1] == 0) {
        XX_im = 0.0;
      } else {
        XX_im = wei->data[0];
        for (k = 2; k <= icomb; k++) {
          XX_im += wei->data[16 * (k - 1)];
        }
      }
      for (b_i = 0; b_i < 256; b_i++) {
        s_re = local_Cx[b_i].re;
        XX_re = local_Cx[b_i].im;
        if (XX_re == 0.0) {
          s_im = s_re / XX_im;
          s_re = 0.0;
        } else if (s_re == 0.0) {
          s_im = 0.0;
          s_re = XX_re / XX_im;
        } else {
          s_im = s_re / XX_im;
          s_re = XX_re / XX_im;
        }
        local_Cx[b_i].re = s_im;
        local_Cx[b_i].im = s_re;
      }
      for (coffset = 0; coffset < 120; coffset++) {
        icomb = (int)pairId[coffset];
        nmkpi = (int)pairId[coffset + 120];
        combj = (icomb - 1) << 4;
        Cx[(((icomb + combj) + Cx_tmp) + 65792 * t) - 1] =
            local_Cx[(icomb + combj) - 1];
        Cx[(((nmkpi + combj) + Cx_tmp) + 65792 * t) - 1] =
            local_Cx[(nmkpi + combj) - 1];
        combj = (nmkpi - 1) << 4;
        Cx[(((icomb + combj) + Cx_tmp) + 65792 * t) - 1] =
            local_Cx[(icomb + combj) - 1];
        Cx[(((nmkpi + combj) + Cx_tmp) + 65792 * t) - 1] =
            local_Cx[(nmkpi + combj) - 1];
      }
    }
  }
  emxFree_creal_T(&a);
  emxFree_creal_T(&r);
  emxFree_creal_T(&XX);
  emxFree_real_T(&wei);
}

/*
 * File trailer for MBSS_qstft_multi.c
 *
 * [EOF]
 */
